# 연관관계 매핑
## 연관관계가 필요한 이유
- 객체 지향 설계의 목표는 자율적인 객체들의 협력 공동체를 만드는 것이다.
- 객체를 테이블에 맞추어 데이터 중심으로 모델링하면, 협력 관계를 만들 수 없다.
  - 테이블은 외래키로 조인을 사용하여 연관된 테이블을 찾는다.
  - 객체는 참조를 사용해서 연관된 객체를 찾는다.
  - 테이블과 객체 사이에는 이런 큰 간격이 있다.

## 단방향 연관관계
- `@ManyToOne`
- `@JoinColumn`

## 양방향 연관관계와 연관관계의 주인
- 테이블에는 양방향 연관관계라는 개념이 없다.
- 이미 외래키만으로도 양방향 연관관계가 성립하기 때문이다.
- 객체에서의 양방향 연관관계 설정
  - `@ManyToOne`, `@OneToMany(mappedBy = ...)`
  - `@JoinColumn`
- 그렇다면 양방향 연관관계가 좋은가?
  - 객체는 기본적으로 단방향 연관관계가 더 깔끔하고 좋다.
  - 양방향 연관관계로 설정 시 신경써줘야할 부분이 점점 더 많아진다.

### mappedBy
- mappedBy를 이해하기 위해서는 객체와 테이블간에 연관관계를 맺는 차이를 이해해야 한다.
  - 객체는 연관관계가 2개다.
    - 참조 관계가 두 객체에 모두 존재해야 양방향 연관관계가 성립한다.
    - 객체의 양방향 관계는 사실 양방향 관계가 아니라 서로 다른 단방향 관계 2개다.
    - 객체를 양방향으로 참조하려면 단방향 연관관계를 2개 만들어야 한다.
  - 테이블은 연관관계가 1개다.
    - 테이블은 외래키 하나로 연관관계 정리가 깔끔하게 해결된다.

### 연관관계의 주인
- 객체의 두 관계중 하나를 연관관계의 주인으로 지정한다.
- 연관관계의 주인만이 외래 키를 관리한다.( 등록, 수정 )
- **주인이 아닌쪽은 읽기만 가능하다.**
- 주인은 mappedBy 속성을 사용하면 안된다.
- 주인이 아니면 mappedBy 속성으로 주인을 지정해줘야한다.
- ***즉, 외래키가 있는 곳을 주인으로 정해주면된다.***

### 만약 연관관계의 주인을 외래키가 없는 곳에 지정해준다면?
- 예를들어 `Member` 테이블에 `TEAM_ID` 외래키가 존재하고, `Member` 엔티티가 `Team` 객체를 매핑하고 있다.
- 또한 `Team` 엔티티에서는 `List<Member>` 객체를 참조하는 양방향 연관관계이다.
- 이때 `Team` 엔티티의 `List<Member>`를 연관관계의 주인으로 설정했다고 가정해보자.
- 그러면 `Team` 엔티티내에서 `List<Member>`에 새로운 `Member`를 `Insert`하는 경우 `Team` 테이블엔 `Insert` 쿼리문이 나가고 `Member` 테이블에는 `Update` 쿼리가 나가는 명확하지 않은 상황이 발생한다.

### 양방향 연관관계 지정시 가장 많이하는 실수
- ***연관관계 주인의 값을 입력해주지 않음***
- **순수한 객체 관계를 고려하면 항상 양쪽 모두에 값을 입력해야한다.**
  - 영속성 컨텍스트와 1차 캐싱을 떠올리면 그 이유를 쉽게 알 수 있다.
  - 영속성 컨텍스트에 `persist`한다고 DB에 바로 매핑되는 것이 아니다.
  - 단순히 연관관계 주인의 값만 입력해준 상태에서 바로 `List<Member>`를 조회하면 아무런 값이 조회가 안된다.
  - 아직 커밋되기 전까지는 아직 DB 테이블에 매핑되지 않고 단순히 영속성 컨텍스트에 저장되어 1차 캐싱된 상태기 때문에 데이터들이 순수한 객체로 남아있기 때문이다.
  - 따라서 기본적으로 양방향 연관관계 지정 시 순수 객체 상태를 고려해서 항상 양쪽 모두에 값을 지정해주는 것이 좋다.
- 연관관계 편의 메소드를 생성하자.
  - 연관관계 편의 메소드는 어디에 생성하든 상관없지만 양쪽 모두에 만들어주는 것은 좋지 않은 방법이다. 자칫 잘못하면 무한루프에 빠질 수 있다.
- 양방향 매핑시에 무한루프를 주의하자.
  - toString()
  - lombok
  - JSON 생성 라이브러리
    - 엔티티를 컨트롤러 단위에서 직접 JSON으로 변환할 때 양방향 연관관계가 걸려있으면 무한루프에 빠지게된다.
    - 따라서 API로 반환할 때 엔티티가 아닌 스펙에 맞는 DTO로 변환해서 사용해야한다.

### 양방향 매핑 정리
- 단방향 매핑만으로도 이미 DB에서의 연관관계 매핑은 완료된다.
- 양방향 매핑은 반대 방향으로 조회( 객체 그래프 탐색 ) 기능이 추가된 것 뿐이다.
  - JPQL에서 역방향으로 탐색할 일이 많다.
- 단방향 매핑을 잘 하고 양방향 매핑은 꼭 필요한 경우에만 추가하자.
  - 양방향 매핑이 테이블에 영향을 주진 않는다.

***
## 다양한 연관관계 매핑
### 연관관계 매핑 시 고려사항 3가지
- 다중성
  - 다대일: `@ManyToOne`
  - 일대다: `@OneToMany`
  - 일대일: `@OneToOne`
  - 다대다: `@ManyToMany`
    - ***다대다는 실무에선 절대 쓰면 안된다.***
- 단방향, 양방향
  - 테이블
    - 외래키 하나로 양쪽 조인 가능
    - 사실 방향이라는 개념이 없음
  - 객체
    - 참조용 필드가 있는 쪽으로만 참조가 가능
    - 한쪽만 참조하면 단방향
    - 양쪽이 서로 참조하면 양방향
      - 엄밀히말하면 양방향이라는 개념은 없고 단방향이 2개이다.
- 연관관계의 주인
  - 테이블은 외래키 하나로 두 테이블이 연관관계를 맺는다.
  - 객체 양방향 관계는 참조가 두 군데 있다. 둘 중 테이블의 외래키를 관리할 곳을 지정해야한다.
  - 즉 연관관계의 주인은 외래키를 관리한다.
  - 주인의 반대편은 외래키에 영향을 주지 않는다. 단순 조회만 가능하다.

### 다대일[N:1]
- N쪽에 외래키가 위치해야한다.

### 일대다[1:N]
- 일대다 단방향은 1:N 관계에서 1이 연관관계의 주인이 된다.
- DB의 테이블에서는 N쪽에 반드시 외래키가 들어가야한다.
- 객체와 테이블의 차이때문에 반대편 테이블의 외래키를 관리하는 특이한 구조다.
- 따라서 `@OneToMany` 쪽에 `@JoinColumn`을 반드시 사용해야한다.
- **권장하는 방식은 아니다.**
  - 일대다 방식을 사용하면 코드를 보고 직관적으로 DB의 연관관계 매핑을 파악하기가 힘들어진다.
    - Team 엔티티를 건드렸지만 내부적으로는 N쪽인 Member 테이블의 TeamID가 업데이트되기 때문에 연관관계가 복잡해질 수록 직관적으로 파악하기 힘들어진다.
  - 엔티티가 관리하는 외래키가 다른 테이블에 있다. 
  - 연관관계 관리를 위해 추가로 UPDATE SQL을 실행해줘야한다.
- 일대다 단방향 매핑보다는 다대일 양방향 매핑을 사용하는 것이 좋다.

### 일대일[1:1]
- 일대일 관계는 그 반대도 일대일
- 주 테이블이나 대상 테이블 중에 외래키 선택 가능
- 외래키에 DB 유니크 제약조건을 추가해줘야 한다.
- 일대일 관계도 외래키를 갖고있는 엔티티가 연관관계의 주인이 된다.

#### 그렇다면 외래키를 어디에 두는 것이 좀 더 나은 방법일까?
- **주 테이블에 외래키**
  - 주 객체가 대상 객체를 참조하는 것 처럼 주 테이블에 외래키를 두고 대상 테이블을 찾는다.
  - 객체지향 개발자가 선호하는 방식이다.
  - JPA 매핑이 편리하다
  - 주 테이블만 조회해도 대상 테이블에 데이터가 있는지 확인할 수 있다.
  - 단점
    - 값이 없으면 외래키에 null을 허용해줘야한다.
- **대상 테이블에 외래키**
  - 대상 테이블에 외래키가 존재한다.
  - 전통적인 데이터베이스 개발자가 선호하는 방식
  - 주 테이블과 대상 테이블을 일대일에서 일대다 관계로 변경할 때 테이블 구조가 유지된다.
  - 단점
    - 어쩔 수 없이 양방향으로 설계해야한다.
      - 주로 주 테이블에서 대상 테이블을 조회하기 때문이다.
    - **프록시 기능의 한계로 지연 로딩으로 설정해도 항상 즉시 로딩된다는 단점이 있다.**

### 다대다[N:M]
#### 다대다 연관관계를 실무에서 사용하면 안되는 이유
- 관계형 데이터베이스는 정규화된 테이블 2개로 다대다 관계를 표현할 수 없음
- 객체는 컬렉션을 사용해서 객체 2개로 다대다 관계가 가능하다. 
- 연결 테이블을 추가해서 일대다, 다대일 관계로 풀어내야한다.
- 연결 테이블이 단순히 연결만 하는 역할을 하는 것은 아니다.
  - ID 값을 제외한 나머지 여러 데이터가 포함될 수 있음
  - 다대다 매핑은 필드를 추가할 수가 없다.
- 따라서 연결 테이블용 엔티티를 추가하는 방식을 권장한다.

